---
# tasks file for kafka_run_connect

- name: Validate required variables
  assert:
    that:
      - kafka_connect_mode is defined
      - kafka_connect_mode in ['standalone', 'distributed']
      - kafka_bin_directory is defined
      - kafka_config_directory is defined
      - kafka_connect_directory is defined
      - kafka_connect_properties_file is defined
    fail_msg: "Validation of input variables failed"

- name: Verificar si el puerto {{ kafka_port_env }} est√° siendo escuchado
  ansible.builtin.shell: ss -tulpn | grep {{ kafka_port_env }}
  register: ss_output
  ignore_errors: true

- name: Verificar si hay conectores disponibles en el servicio
  ansible.builtin.shell: "curl -s {{ kafka_connect_api_url }}"
  register: curl_output
  ignore_errors: true

- name: Establecer 'run_connect' a true si se encuentra alguna salida
  set_fact:
    run_connect: true
  when: ss_output.stdout != "" or (curl_output.stdout != "" and curl_output.stdout != "[]")

- name: Mostrar el valor de 'run_connect'
  ansible.builtin.debug:
    var: run_connect


- name: "Generate properties for mode {{ kafka_connect_mode }}"
  template:
    src: "templates/connect-{{ kafka_connect_mode }}.properties.j2"
    dest: "{{ kafka_connect_directory }}/connect-{{ kafka_connect_mode }}.properties"
    mode: '0774'
    force: true

- name: Execute Kafka Connect with configuration files
  shell: "{{ connect_command }}"