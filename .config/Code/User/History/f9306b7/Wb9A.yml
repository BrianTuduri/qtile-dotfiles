---
# tasks file for kafka_run_connect

- name: "Generate properties for mode {{ kafka_connect_mode }}"
  template:
    src: "{{ repo_home }}/ansible/templates/connect-{{ kafka_connect_mode }}.properties.j2"
    dest: "{{ kafka_config_directory }}/{{ ambiente }}/connect-{{ kafka_connect_mode }}.properties"
    mode: '0774'
    force: true

- name: Validate required variables
  assert:
    that:
      - kafka_connect_mode is defined
      - kafka_connect_mode in ['standalone', 'distributed']
      - kafka_bin_directory is defined
      - kafka_config_directory is defined
      - kafka_connect_properties_file is defined
    fail_msg: "Validation of input variables failed"

- name: Execute Kafka Connect with configuration files
  shell: |
    nohup sh {{ kafka_bin_directory }}/connect-{{ kafka_connect_mode }}.sh {{ kafka_config_directory }}/{{ kafka_connect_properties_file }} {% for file in kafka_connect_config_files %}{{ kafka_config_directory }}/{{ file }} {% endfor %}& > {{ kafka_bin_directory }}/connect_output.log 2> {{ kafka_bin_directory }}/connect_error.log
  when: kafka_connect_config_files is defined and kafka_connect_config_files | length > 0