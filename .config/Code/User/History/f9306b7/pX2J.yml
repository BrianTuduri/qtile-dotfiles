---
# tasks file for kafka_run_connect

- name: Validate required variables
  assert:
    that:
      - kafka_connect_mode is defined
      - kafka_connect_mode in ['standalone', 'distributed']
      - kafka_bin_directory is defined
      - kafka_config_directory is defined
      - kafka_connect_directory is defined
      - kafka_connect_properties_file is defined
    fail_msg: "Validation of input variables failed"

- name: "Get the PID of the service on the port {{ kafka_connect_port_env }}"
  ansible.builtin.shell: lsof -i :{{ kafka_connect_port_env }} | awk 'NR==2{print $2}'
  register: lsof_output
  ignore_errors: true

- name: Check if there are connectors available in service
  ansible.builtin.shell: "curl -s {{ kafka_connect_api_url }}"
  register: curl_output
  ignore_errors: true

- name: Set 'run_connect' to true if PID found or connectors available
  set_fact:
    run_connect: true
  when: lsof_output.stdout != "" or curl_output.stdout != ""

- name: "Kill process on port {{ kafka_connect_port_env }} if 'run_connect' is true"
  ansible.builtin.shell: kill -9 {{ lsof_output.stdout }}
  when: run_connect and lsof_output.stdout != ""

- name: Display the value of 'run_connect'
  ansible.builtin.debug:
    var: run_connect

- name: "Generate properties for mode {{ kafka_connect_mode }}"
  template:
    src: "templates/connect-{{ kafka_connect_mode }}.properties.j2"
    dest: "{{ kafka_connect_directory }}/connect-{{ kafka_connect_mode }}.properties"
    mode: '0774'
    force: true

- name: Execute Kafka Connect with configuration files
  shell: "{{ connect_command }}"