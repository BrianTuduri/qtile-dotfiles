FROM nexus.geocom.com.uy/openjdk:8-jdk

# Definición de variables de entorno
ENV GRADLE_VERSION=4.10.3 \
    GRADLE_HOME=/opt/gradle/gradle-$GRADLE_VERSION \
    NVM_DIR=/usr/local/nvm \
    NODE_VERSION=6.3.0

# Instalación de dependencias y herramientas
RUN apt-get update && \
    apt-get install -y wget curl git ca-certificates tar unzip && \
    rm -rf /var/lib/apt/lists/* && \
    mkdir -p ${GRADLE_HOME} ${NVM_DIR} && \
    wget https://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-all.zip && \
    unzip -d /opt/gradle gradle-${GRADLE_VERSION}-all.zip && \
    rm gradle-${GRADLE_VERSION}-all.zip

# Instalación de nvm y Node.js
RUN curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash && \
    . "$NVM_DIR/nvm.sh" && \
    nvm install $NODE_VERSION && \
    nvm use $NODE_VERSION && \
    nvm alias default $NODE_VERSION

# Creación y configuración del usuario no-root
ARG user=jenkins
ARG group=jenkins
ARG uid=1000
ARG gid=1000
RUN groupadd -g ${gid} ${group} && \
    useradd -d /home/${user} -u ${uid} -g ${group} -m ${user}

# Asegurarse de que los scripts de nvm se carguen en cada sesión shell para el usuario jenkins
RUN echo "export NVM_DIR=\"$NVM_DIR\"" >> /home/${user}/.bashrc && \
    echo "[ -s \"$NVM_DIR/nvm.sh\" ] && \. \"$NVM_DIR/nvm.sh\"" >> /home/${user}/.bashrc && \
    echo "[ -s \"$NVM_DIR/bash_completion\" ] && \. \"$NVM_DIR/bash_completion\"" >> /home/${user}/.bashrc && \
    echo "export PATH=\"$GRADLE_HOME/bin:\$PATH\"" >> /home/${user}/.bashrc

# Cambiar la propiedad de los directorios al usuario jenkins
RUN chown -R ${uid}:${gid} ${NVM_DIR} /opt/gradle /home/${user}

# Cambiar al usuario
USER ${user}
WORKDIR /project
