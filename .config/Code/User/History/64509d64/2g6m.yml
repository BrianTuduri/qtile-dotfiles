---
- name: Setup Kafka
  hosts: keepalived
  gather_facts: yes
  become: yes
  become_user: root
  remote_user: root
  roles:
    - geocom.geoscm.kafka_setup_provisioning
  vars:
    # extras directories
    - kafka_extras_directories: 
        - "{{ kafka_client_config_directory }}"
        - "{{ kafka_plugin_directory }}"
        - "{{ kafka_topics_dir }}"
        - "{{ kafka_connectors_dir }}"
    # topics
    - kafka_src_local_topics_dir: "{{ kafka_local_topics_dir }}"
    - kafka_dest_topics_dir: "{{ kafka_topics_dir }}"
    # connectors
    - kafka_src_local_connectors_dir: "{{ kafka_local_connectors_dir }}/"
    - kafka_dest_connectors_dir: "{{ kafka_connectors_dir }}"
    # plugins
    - kafka_src_plugin_directory: "{{ repo_home }}/plugins/"
    - kafka_dest_plugin_directory: "{{ kafka_plugin_directory }}"
    # debug
    - setup_debug: false
  tags:
    - "apply-topic"
    - "add_connectors"
    - "apply_connect"

- name: Crear topics
  hosts: keepalived
  gather_facts: yes
  become: yes
  become_user: root
  remote_user: root
  roles:
    - geocom.geoscm.kafka_add_topic
  vars:
    - topic_files_path: "{{ kafka_topics_dir }}"
  tags: 
    - "apply-topic"

- name: Create connect
  hosts: keepalived
  gather_facts: yes
  become: yes
  become_user: root
  remote_user: root
  roles:
    - geocom.geoscm.kafka_run_connect
  vars:
    - kafka_connect_port_env: "{{ kafka_connect_port_env }}"
    - kafka_connect_api_url: "{{ kafka_connect_api_url }}"
    - kafka_connect_mode: "distributed"
    - kafka_connect_directory: "{{ kafka_config_directory }}/{{ ambiente }}"
    - kafka_connect_properties_file: "connect-distributed.properties"
    - kafka_connect_config_files: []
    - connector_debug: false
  tags: 
    - "apply-connect"

- name: Create connectors
  hosts: keepalived
  gather_facts: yes
  become: yes
  become_user: root
  remote_user: root
  roles:
    - geocom.geoscm.kafka_create_connector
  vars:
    - kafka_connect_api_url: "{{ kafka_connect_api_url }}"
    - kafka_connectors_dir: " {{ kafka_local_connectors_dir }}"
    - connector_debug: false
  tags: 
    - "add-connectors"

- name: Delete topics
  hosts: keepalived
  gather_facts: yes
  become: yes
  become_user: root
  remote_user: root
  roles:
    - geocom.geoscm.kafka_delete_topic
  vars:
    - topic_files_path: "{{ kafka_topics_dir }}"
  tags: 
    - "delete-topics"

- name: Delete connectors
  hosts: keepalived
  gather_facts: yes
  become: yes
  become_user: root
  remote_user: root
  roles:
    - geocom.geoscm.kafka_delete_connector
  vars:
    - kafka_connect_api_url: "{{ kafka_connect_api_url }}"
    - kafka_connectors_dir: " {{ kafka_local_connectors_dir }}"
    - connector_debug: false
  tags: 
    - "delete-connectors"