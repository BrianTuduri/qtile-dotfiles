---
- name: Leer contenido del archivo YAML
  ansible.builtin.slurp:
    src: "{{ file.path }}"
  register: file_content

- name: Archivo actual
  debug:
    msg: "File content is: {{ file.path }}"
  when: connector_debug

- name: Convertir contenido a YAML
  set_fact:
    connector_config_yml: "{{ file_content['content'] | b64decode | from_yaml }}"

- name: Recolectar informacion de el connector
  set_fact:
    connector_name: "{{ connector_config_yml.connector.name }}"

- name: Transformar configuración de YAML a JSON para la API
  set_fact:
    connector_config: "{{ connector_config_yml.connector | to_nice_json }}"

- name: Connector config output
  debug:
    msg: "Connector config is: {{ connector_config }}"
  when: connector_debug

- name: "Publicar configuración del conector '{{ connector_name }}' a Kafka Connect"
  uri:
    url: "{{ kafka_connect_api_url }}"
    method: DELETE
    body: "{}"
    body_format: json
    status_code: [201, 200, 409]
    return_content: yes
  register: response
  ignore_errors: true

# status code 200
- name: Operación exitosa
  debug: 
    msg: "La operación se ha completado con éxito."
  when: response.status == 200

# status code 201
- name: Conector creado
  debug: 
    msg: "El conector ha sido creado exitosamente."
  when: response.status == 201

# status code 202
- name: Solicitud aceptada
  debug: 
    msg: "La solicitud ha sido aceptada y está en proceso."
  when: response.status == 202

# status code 204
- name: Operación sin contenido
  debug: 
    msg: "La operación se ha completado con éxito, pero no hay contenido para devolver."
  when: response.status == 204

# status code 409
- name: Conector existente
  debug: 
    msg: "Connector {{ response.json.message | regex_replace('Connector ', '') | regex_replace(' already exists', '') }} already exists."
  when: response.status == 409

# status code 422
- name: Entidad no procesable
  debug: 
    msg: "La solicitud no pudo ser procesada debido a problemas con los datos enviados."
  when: response.status == 422

# status code 404
- name: Recurso no encontrado
  debug: 
    msg: "El recurso solicitado no se encuentra disponible."
  when: response.status == 404

# status code 500
- name: Error interno del servidor
  debug: 
    msg: "El servidor encontró una condición inesperada que impidió completar la solicitud."
  when: response.status == 500